#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã –¥–ª—è Auto Montage Builder Pro
"""

import time
import logging
from typing import List, Dict, Optional, Set
from pathlib import Path

from PySide6.QtWidgets import *
from PySide6.QtCore import *
from PySide6.QtGui import *

from models import Channel, EffectSettings, ExportSettings, OverlaySettings
from gui_base import BaseWidget

logger = logging.getLogger(__name__)

# ==================== –ö–ê–†–¢–û–ß–ö–ò –ö–ê–ù–ê–õ–û–í ====================

class ChannelCard(QFrame):
    """–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–Ω–∞–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ"""
    
    clicked = Signal()
    edit_requested = Signal(str)
    delete_requested = Signal(str)
    duplicate_requested = Signal(str)
    export_requested = Signal(str)
    
    def __init__(self, channel: Channel, selected: bool = False, parent=None):
        super().__init__(parent)
        self.channel = channel
        self.selected = selected
        self.setup_ui()
        self.update_style()
    
    def setup_ui(self):
        self.setFrameStyle(QFrame.Box)
        layout = QVBoxLayout()
        layout.setSpacing(8)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π
        header_layout = QHBoxLayout()
        
        # –ò–∫–æ–Ω–∫–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
        icon_label = QLabel()
        icon_map = {
            "youtube": "üì∫",
            "shorts": "üì±", 
            "instagram": "üì∑",
            "cinematic": "üé¨"
        }
        icon = icon_map.get(self.channel.template, "üìπ")
        icon_label.setText(icon)
        icon_label.setStyleSheet("font-size: 20px;")
        header_layout.addWidget(icon_label)
        
        name_label = QLabel(self.channel.name)
        name_label.setStyleSheet("font-weight: bold; font-size: 14px;")
        header_layout.addWidget(name_label)
        
        header_layout.addStretch()
        
        # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        self._create_action_buttons(header_layout)
        
        layout.addLayout(header_layout)
        
        # –û–ø–∏—Å–∞–Ω–∏–µ
        if self.channel.description:
            desc_label = QLabel(self.channel.description)
            desc_label.setObjectName("infoLabel")
            desc_label.setWordWrap(True)
            layout.addWidget(desc_label)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        info_label = QLabel(
            f"{self.channel.export.resolution} ‚Ä¢ "
            f"{self.channel.export.fps}fps ‚Ä¢ "
            f"{self.channel.export.bitrate}Mbps"
        )
        info_label.setObjectName("infoLabel")
        layout.addWidget(info_label)
        
        # –¢–µ–≥–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        tags_widget = self._create_tags_widget()
        layout.addWidget(tags_widget)
        
        self.setLayout(layout)
    
    def _create_action_buttons(self, layout: QHBoxLayout):
        """–°–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π"""
        button_style = """
            QPushButton {
                background: transparent;
                border: none;
                font-size: 16px;
                padding: 4px;
                border-radius: 4px;
            }
            QPushButton:hover {
                background-color: #3d3d3d;
            }
        """
        
        # –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        edit_btn = QPushButton("‚úèÔ∏è")
        edit_btn.setToolTip("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª")
        edit_btn.setStyleSheet(button_style)
        edit_btn.setFixedSize(28, 28)
        edit_btn.clicked.connect(lambda: self.edit_requested.emit(self.channel.id))
        layout.addWidget(edit_btn)
        
        # –ö–Ω–æ–ø–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        duplicate_btn = QPushButton("üìã")
        duplicate_btn.setToolTip("–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª")
        duplicate_btn.setStyleSheet(button_style)
        duplicate_btn.setFixedSize(28, 28)
        duplicate_btn.clicked.connect(lambda: self.duplicate_requested.emit(self.channel.id))
        layout.addWidget(duplicate_btn)
        
        # –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        export_btn = QPushButton("üì§")
        export_btn.setToolTip("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª")
        export_btn.setStyleSheet(button_style)
        export_btn.setFixedSize(28, 28)
        export_btn.clicked.connect(lambda: self.export_requested.emit(self.channel.id))
        layout.addWidget(export_btn)
        
        # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        delete_btn = QPushButton("üóëÔ∏è")
        delete_btn.setToolTip("–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª")
        delete_btn.setStyleSheet(button_style + """
            QPushButton:hover {
                background-color: #d32f2f;
            }
        """)
        delete_btn.setFixedSize(28, 28)
        delete_btn.clicked.connect(lambda: self.delete_requested.emit(self.channel.id))
        layout.addWidget(delete_btn)
    
    def _create_tags_widget(self) -> QWidget:
        """–°–æ–∑–¥–∞–µ—Ç –≤–∏–¥–∂–µ—Ç —Å —Ç–µ–≥–∞–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤"""
        widget = QWidget()
        layout = QHBoxLayout()
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(4)
        
        tag_style = """
            QLabel {
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
            }
        """
        
        # Ken Burns
        if self.channel.effects.ken_burns:
            tag = QLabel("Ken Burns")
            tag.setStyleSheet(tag_style + "background: #00d4aa22; color: #00d4aa;")
            layout.addWidget(tag)
        
        # CapCut FX
        if self.channel.effects.capcut_effects:
            tag = QLabel("CapCut FX")
            tag.setStyleSheet(tag_style + "background: #ff4fe622; color: #ff4fe6;")
            layout.addWidget(tag)
        
        # –û–≤–µ—Ä–ª–µ–∏
        if self.channel.overlays.enabled:
            tag = QLabel("–û–≤–µ—Ä–ª–µ–∏")
            tag.setStyleSheet(tag_style + "background: #4fc3f722; color: #4fc3f7;")
            layout.addWidget(tag)
        
        # 3D
        if self.channel.effects.enable_3d_parallax:
            tag = QLabel("3D")
            tag.setStyleSheet(tag_style + "background: #ffd54f22; color: #ffd54f;")
            layout.addWidget(tag)
        
        # –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è
        if self.channel.effects.color_correction:
            tag = QLabel(self.channel.effects.color_filter.title())
            tag.setStyleSheet(tag_style + "background: #ab47bc22; color: #ab47bc;")
            layout.addWidget(tag)
        
        layout.addStretch()
        widget.setLayout(layout)
        return widget
    
    def update_style(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏"""
        if self.selected:
            self.setStyleSheet("""
                ChannelCard {
                    background-color: #00d4aa22;
                    border: 2px solid #00d4aa;
                    border-radius: 8px;
                    padding: 12px;
                }
            """)
        else:
            self.setStyleSheet("""
                ChannelCard {
                    background-color: #2d2d2d;
                    border: 1px solid #444;
                    border-radius: 8px;
                    padding: 12px;
                }
                ChannelCard:hover {
                    background-color: #3d3d3d;
                    border-color: #555;
                }
            """)
    
    def mousePressEvent(self, event: QMouseEvent):
        if event.button() == Qt.LeftButton:
            self.clicked.emit()
        super().mousePressEvent(event)
    
    def set_selected(self, selected: bool):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞"""
        self.selected = selected
        self.update_style()

# ==================== –î–ò–ê–õ–û–ì –ö–ê–ù–ê–õ–ê ====================

class ChannelDialog(QDialog):
    """–î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞"""
    
    def __init__(self, channel: Optional[Channel] = None, parent=None):
        super().__init__(parent)
        self.channel = channel
        self.is_edit_mode = channel is not None
        
        self.setWindowTitle("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª" if self.is_edit_mode else "–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª")
        self.setModal(True)
        self.setMinimumSize(600, 500)
        
        self.setup_ui()
        
        if self.is_edit_mode:
            self.load_channel_data()
    
    def setup_ui(self):
        layout = QVBoxLayout()
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        info_group = QGroupBox("üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
        info_layout = QFormLayout()
        
        self.name_edit = QLineEdit()
        self.name_edit.setPlaceholderText("–ù–∞–ø—Ä–∏–º–µ—Ä: YouTube –∫–∞–Ω–∞–ª")
        info_layout.addRow("–ù–∞–∑–≤–∞–Ω–∏–µ:", self.name_edit)
        
        self.description_edit = QLineEdit()
        self.description_edit.setPlaceholderText("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞")
        info_layout.addRow("–û–ø–∏—Å–∞–Ω–∏–µ:", self.description_edit)
        
        self.template_combo = QComboBox()
        self.template_combo.addItems([
            ("youtube", "YouTube (16:9)"),
            ("shorts", "Shorts/Reels (9:16)"),
            ("instagram", "Instagram (1:1)"),
            ("cinematic", "Cinematic (21:9)"),
            ("custom", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π")
        ])
        self.template_combo.currentIndexChanged.connect(self._on_template_changed)
        info_layout.addRow("–®–∞–±–ª–æ–Ω:", self.template_combo)
        
        info_group.setLayout(info_layout)
        layout.addWidget(info_group)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        export_group = QGroupBox("üé¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞")
        export_layout = QFormLayout()
        
        # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ
        resolution_layout = QHBoxLayout()
        self.resolution_combo = QComboBox()
        self.resolution_combo.addItems([
            "1920x1080", "3840x2160", "2560x1440", "1280x720",
            "1080x1920", "1080x1080", "720x1280", "custom"
        ])
        self.resolution_combo.currentTextChanged.connect(self._on_resolution_changed)
        resolution_layout.addWidget(self.resolution_combo)
        
        self.custom_resolution_widget = QWidget()
        custom_res_layout = QHBoxLayout()
        custom_res_layout.setContentsMargins(0, 0, 0, 0)
        
        self.width_spin = QSpinBox()
        self.width_spin.setRange(320, 7680)
        self.width_spin.setValue(1920)
        custom_res_layout.addWidget(QLabel("–®:"))
        custom_res_layout.addWidget(self.width_spin)
        
        self.height_spin = QSpinBox()
        self.height_spin.setRange(240, 4320)
        self.height_spin.setValue(1080)
        custom_res_layout.addWidget(QLabel("–í:"))
        custom_res_layout.addWidget(self.height_spin)
        
        self.custom_resolution_widget.setLayout(custom_res_layout)
        self.custom_resolution_widget.setVisible(False)
        resolution_layout.addWidget(self.custom_resolution_widget)
        
        export_layout.addRow("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:", resolution_layout)
        
        # FPS
        self.fps_spin = QSpinBox()
        self.fps_spin.setRange(1, 120)
        self.fps_spin.setValue(30)
        self.fps_spin.setSuffix(" fps")
        export_layout.addRow("–ß–∞—Å—Ç–æ—Ç–∞ –∫–∞–¥—Ä–æ–≤:", self.fps_spin)
        
        # –ë–∏—Ç—Ä–µ–π—Ç
        self.bitrate_spin = QSpinBox()
        self.bitrate_spin.setRange(1, 100)
        self.bitrate_spin.setValue(8)
        self.bitrate_spin.setSuffix(" Mbps")
        export_layout.addRow("–ë–∏—Ç—Ä–µ–π—Ç:", self.bitrate_spin)
        
        # –ö–∞—á–µ—Å—Ç–≤–æ
        self.quality_combo = QComboBox()
        self.quality_combo.addItems([
            ("veryfast", "–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ"),
            ("faster", "–ë—ã—Å—Ç—Ä–æ"),
            ("fast", "–ë—ã—Å—Ç—Ä–æ+"),
            ("medium", "–ë–∞–ª–∞–Ω—Å"),
            ("slow", "–ö–∞—á–µ—Å—Ç–≤–æ"),
            ("slower", "–ö–∞—á–µ—Å—Ç–≤–æ+"),
            ("veryslow", "–ú–∞–∫—Å–∏–º—É–º")
        ])
        self.quality_combo.setCurrentIndex(3)  # medium
        export_layout.addRow("–ü—Ä–µ—Å–µ—Ç –∫–∞—á–µ—Å—Ç–≤–∞:", self.quality_combo)
        
        export_group.setLayout(export_layout)
        layout.addWidget(export_group)
        
        # –ë—ã—Å—Ç—Ä—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        effects_group = QGroupBox("‚ú® –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤")
        effects_layout = QVBoxLayout()
        
        self.enable_ken_burns = QCheckBox("–í–∫–ª—é—á–∏—Ç—å Ken Burns —ç—Ñ—Ñ–µ–∫—Ç—ã")
        effects_layout.addWidget(self.enable_ken_burns)
        
        self.enable_transitions = QCheckBox("–í–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∫–ª–∏–ø–∞–º–∏")
        effects_layout.addWidget(self.enable_transitions)
        
        self.enable_capcut = QCheckBox("–í–∫–ª—é—á–∏—Ç—å CapCut —ç—Ñ—Ñ–µ–∫—Ç—ã")
        effects_layout.addWidget(self.enable_capcut)
        
        self.enable_color = QCheckBox("–í–∫–ª—é—á–∏—Ç—å —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—é")
        effects_layout.addWidget(self.enable_color)
        
        effects_group.setLayout(effects_layout)
        layout.addWidget(effects_group)
        
        # –ö–Ω–æ–ø–∫–∏
        button_layout = QHBoxLayout()
        
        self.cancel_btn = QPushButton("–û—Ç–º–µ–Ω–∞")
        self.cancel_btn.clicked.connect(self.reject)
        button_layout.addWidget(self.cancel_btn)
        
        button_layout.addStretch()
        
        self.save_btn = QPushButton("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" if self.is_edit_mode else "–°–æ–∑–¥–∞—Ç—å")
        self.save_btn.setObjectName("primaryButton")
        self.save_btn.clicked.connect(self._validate_and_accept)
        button_layout.addWidget(self.save_btn)
        
        layout.addLayout(button_layout)
        
        self.setLayout(layout)
    
    def _on_template_changed(self, index: int):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞"""
        template = self.template_combo.currentData()
        
        template_settings = {
            "youtube": {"resolution": "1920x1080", "fps": 30, "bitrate": 8},
            "shorts": {"resolution": "1080x1920", "fps": 30, "bitrate": 10},
            "instagram": {"resolution": "1080x1080", "fps": 30, "bitrate": 6},
            "cinematic": {"resolution": "3840x2160", "fps": 24, "bitrate": 20}
        }
        
        if template in template_settings:
            settings = template_settings[template]
            self.resolution_combo.setCurrentText(settings["resolution"])
            self.fps_spin.setValue(settings["fps"])
            self.bitrate_spin.setValue(settings["bitrate"])
    
    def _on_resolution_changed(self, text: str):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"""
        self.custom_resolution_widget.setVisible(text == "custom")
    
    def _validate_and_accept(self):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"""
        if not self.name_edit.text().strip():
            QMessageBox.warning(self, "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞")
            return
        
        self.accept()
    
    def load_channel_data(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞"""
        if not self.channel:
            return
        
        self.name_edit.setText(self.channel.name)
        self.description_edit.setText(self.channel.description)
        
        # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω
        for i in range(self.template_combo.count()):
            if self.template_combo.itemData(i) == self.channel.template:
                self.template_combo.setCurrentIndex(i)
                break
        
        # –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        self.resolution_combo.setCurrentText(self.channel.export.resolution)
        if self.channel.export.resolution == "custom":
            self.width_spin.setValue(self.channel.export.custom_width)
            self.height_spin.setValue(self.channel.export.custom_height)
        
        self.fps_spin.setValue(self.channel.export.fps)
        self.bitrate_spin.setValue(self.channel.export.bitrate)
        
        # –ù–∞—Ö–æ–¥–∏–º –∫–∞—á–µ—Å—Ç–≤–æ
        for i in range(self.quality_combo.count()):
            if self.quality_combo.itemData(i) == self.channel.export.quality.preset:
                self.quality_combo.setCurrentIndex(i)
                break
        
        # –≠—Ñ—Ñ–µ–∫—Ç—ã
        self.enable_ken_burns.setChecked(bool(self.channel.effects.ken_burns))
        self.enable_transitions.setChecked(bool(self.channel.effects.transitions))
        self.enable_capcut.setChecked(bool(self.channel.effects.capcut_effects))
        self.enable_color.setChecked(self.channel.effects.color_correction)
    
    def get_channel(self) -> Channel:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–∞–Ω–∞–ª"""
        from models import Channel, ExportSettings, VideoQuality, EffectSettings
        
        if self.channel:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
            channel = self.channel
        else:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            channel = Channel(
                id=f"channel_{int(time.time())}",
                name="",
                description="",
                template="youtube"
            )
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        channel.name = self.name_edit.text().strip()
        channel.description = self.description_edit.text().strip()
        channel.template = self.template_combo.currentData() or "youtube"
        
        # –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        resolution = self.resolution_combo.currentText()
        if resolution == "custom":
            channel.export.custom_width = self.width_spin.value()
            channel.export.custom_height = self.height_spin.value()
        channel.export.resolution = resolution
        channel.export.fps = self.fps_spin.value()
        channel.export.bitrate = self.bitrate_spin.value()
        channel.export.quality.preset = self.quality_combo.currentData() or "medium"
        
        # –ë—ã—Å—Ç—Ä—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        if self.enable_ken_burns.isChecked() and not channel.effects.ken_burns:
            channel.effects.ken_burns = ["zoomIn", "panRight"]
        elif not self.enable_ken_burns.isChecked():
            channel.effects.ken_burns = []
        
        if self.enable_transitions.isChecked() and not channel.effects.transitions:
            channel.effects.transitions = ["fade", "dissolve"]
        elif not self.enable_transitions.isChecked():
            channel.effects.transitions = []
        
        if self.enable_capcut.isChecked() and not channel.effects.capcut_effects:
            channel.effects.capcut_effects = ["zoomBurst", "bounce"]
        elif not self.enable_capcut.isChecked():
            channel.effects.capcut_effects = []
        
        channel.effects.color_correction = self.enable_color.isChecked()
        if self.enable_color.isChecked() and channel.effects.color_filter == "none":
            channel.effects.color_filter = "cinematic"
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        channel.validate()
        
        return channel

# ==================== –ü–ê–ù–ï–õ–¨ –ü–†–û–ï–ö–¢–ê ====================

class ProjectInfoPanel(BaseWidget):
    """–ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ"""
    
    scan_requested = Signal()
    folder_changed = Signal(str)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.project_folder = None
        self.setup_ui()
    
    def setup_ui(self):
        layout = QVBoxLayout()
        
        # –í—ã–±–æ—Ä –ø–∞–ø–∫–∏
        folder_group = QGroupBox("üìÅ –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞")
        folder_layout = QVBoxLayout()
        
        path_layout = QHBoxLayout()
        self.path_edit = QLineEdit()
        self.path_edit.setPlaceholderText("–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –º–µ–¥–∏–∞ —Ñ–∞–π–ª–∞–º–∏...")
        self.path_edit.setReadOnly(True)
        path_layout.addWidget(self.path_edit)
        
        self.browse_btn = QPushButton("–û–±–∑–æ—Ä...")
        self.browse_btn.clicked.connect(self._browse_folder)
        path_layout.addWidget(self.browse_btn)
        
        self.scan_btn = QPushButton("üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å")
        self.scan_btn.clicked.connect(self.scan_requested.emit)
        self.scan_btn.setEnabled(False)
        path_layout.addWidget(self.scan_btn)
        
        folder_layout.addLayout(path_layout)
        
        # –û–ø—Ü–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        self.include_videos_check = QCheckBox("–í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã")
        self.include_videos_check.setChecked(True)
        folder_layout.addWidget(self.include_videos_check)
        
        folder_group.setLayout(folder_layout)
        layout.addWidget(folder_group)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
        info_group = QGroupBox("üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ")
        info_layout = QVBoxLayout()
        
        self.info_text = QTextEdit()
        self.info_text.setReadOnly(True)
        self.info_text.setMaximumHeight(150)
        self.info_text.setPlainText("–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ '–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å'")
        info_layout.addWidget(self.info_text)
        
        info_group.setLayout(info_layout)
        layout.addWidget(info_group)
        
        self.setLayout(layout)
    
    def _browse_folder(self):
        """–í—ã–±–æ—Ä –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞"""
        folder = QFileDialog.getExistingDirectory(
            self, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞",
            str(self.project_folder) if self.project_folder else ""
        )
        
        if folder:
            self.set_project_folder(folder)
    
    def set_project_folder(self, folder: str):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"""
        self.project_folder = Path(folder)
        self.path_edit.setText(str(self.project_folder))
        self.scan_btn.setEnabled(True)
        self.folder_changed.emit(folder)
    
    def update_info(self, scan_result: Dict[str, int]):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ"""
        info_text = f"""üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:

‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {scan_result.get('images', 0)}
üé• –í–∏–¥–µ–æ: {scan_result.get('videos', 0)}
üéµ –ê—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤: {scan_result.get('audio', 0)}
üìé –ì–æ—Ç–æ–≤—ã—Ö –ø–∞—Ä: {scan_result.get('pairs', 0)}

–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–æ–≤:
‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 0001_image.jpg + 0001_audio.mp3
‚Ä¢ –í–∏–¥–µ–æ: 0002_video.mp4 + 0002_audio.mp3

–°—Ç–∞—Ç—É—Å: {'‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏' if scan_result.get('pairs', 0) > 0 else '‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–∞—Ä —Ñ–∞–π–ª–æ–≤'}"""
        
        self.info_text.setPlainText(info_text)
    
    def get_include_videos(self) -> bool:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ"""
        return self.include_videos_check.isChecked()

# ==================== –ü–ê–ù–ï–õ–¨ –í–´–ë–û–†–ê –ö–ê–ù–ê–õ–û–í ====================

class ChannelSelectionPanel(BaseWidget):
    """–ü–∞–Ω–µ–ª—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"""
    
    selection_changed = Signal(set)  # Set[str] - IDs –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.channels: List[Channel] = []
        self.selected_ids: Set[str] = set()
        self.channel_cards: Dict[str, ChannelCard] = {}
        self.setup_ui()
    
    def setup_ui(self):
        layout = QVBoxLayout()
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        header_layout = QHBoxLayout()
        
        title = QLabel("üì∫ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
        title.setStyleSheet("font-weight: bold; font-size: 14px;")
        header_layout.addWidget(title)
        
        header_layout.addStretch()
        
        select_all_btn = QPushButton("–í—ã–±—Ä–∞—Ç—å –≤—Å–µ")
        select_all_btn.clicked.connect(self.select_all)
        header_layout.addWidget(select_all_btn)
        
        deselect_all_btn = QPushButton("–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ")
        deselect_all_btn.clicked.connect(self.deselect_all)
        header_layout.addWidget(deselect_all_btn)
        
        layout.addLayout(header_layout)
        
        # –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        
        self.cards_widget = QWidget()
        self.cards_layout = QGridLayout()
        self.cards_layout.setSpacing(10)
        self.cards_widget.setLayout(self.cards_layout)
        
        scroll.setWidget(self.cards_widget)
        layout.addWidget(scroll)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±–æ—Ä–µ
        self.selection_info = QLabel("–í—ã–±—Ä–∞–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: 0")
        self.selection_info.setObjectName("infoLabel")
        layout.addWidget(self.selection_info)
        
        self.setLayout(layout)
    
    def set_channels(self, channels: List[Channel]):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤"""
        self.channels = channels
        self._rebuild_cards()
    
    def _rebuild_cards(self):
        """–ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–Ω–∞–ª–æ–≤"""
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        while self.cards_layout.count():
            item = self.cards_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
        
        self.channel_cards.clear()
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        columns = 2
        for i, channel in enumerate(self.channels):
            card = ChannelCard(channel, channel.id in self.selected_ids)
            card.clicked.connect(lambda ch_id=channel.id: self._toggle_selection(ch_id))
            
            self.channel_cards[channel.id] = card
            self.cards_layout.addWidget(card, i // columns, i % columns)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Ç—è–∂–∫—É –≤ –∫–æ–Ω–µ—Ü
        self.cards_layout.setRowStretch(len(self.channels) // columns + 1, 1)
        
        self._update_selection_info()
    
    def _toggle_selection(self, channel_id: str):
        """–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞"""
        if channel_id in self.selected_ids:
            self.selected_ids.remove(channel_id)
        else:
            self.selected_ids.add(channel_id)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if channel_id in self.channel_cards:
            card = self.channel_cards[channel_id]
            card.set_selected(channel_id in self.selected_ids)
        
        self._update_selection_info()
        self.selection_changed.emit(self.selected_ids.copy())
    
    def select_all(self):
        """–í—ã–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫–∞–Ω–∞–ª—ã"""
        self.selected_ids = {ch.id for ch in self.channels}
        for channel_id, card in self.channel_cards.items():
            card.set_selected(True)
        self._update_selection_info()
        self.selection_changed.emit(self.selected_ids.copy())
    
    def deselect_all(self):
        """–°–Ω–∏–º–∞–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤"""
        self.selected_ids.clear()
        for card in self.channel_cards.values():
            card.set_selected(False)
        self._update_selection_info()
        self.selection_changed.emit(self.selected_ids.copy())
    
    def _update_selection_info(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±–æ—Ä–µ"""
        count = len(self.selected_ids)
        self.selection_info.setText(f"–í—ã–±—Ä–∞–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: {count}")
    
    def get_selected_channels(self) -> List[Channel]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã"""
        return [ch for ch in self.channels if ch.id in self.selected_ids]